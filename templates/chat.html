{% extends 'base.html' %}

{% block title %}Chat{% endblock %}

{% block content %}
<div class="container chat-container mt-4">
    <h2>Chat with {{ other_user_name }}</h2>
    <button id="message-seller-button" class="btn btn-primary mt-3">Message Seller</button>
    <div id="chat-box" class="chat-box">
        <div class="message you">
            <div class="sender">You</div>
            <div class="content">Hi, how are you?</div>
        </div>
        <div class="message them">
            <div class="sender">{{ other_user_name }}</div>
            <div class="content">I'm good, thanks!</div>
        </div>
    </div>
    <div class="chat-input-container mt-3">
        <input type="text" id="message-input" class="form-control" placeholder="Type a message...">
        <button id="send-button" class="btn btn-primary mt-2">Send</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const conversationId = "{{ conversation_id }}";
    const userId = "{{ session['id'] }}";
    const otherUserName = "{{ other_user_name }}";
    const sellerId = "{{ seller_id }}";
    const itemId = "{{ item_id }}";
    const wsUrl = `ws://127.0.0.1:8000/conversations/ws/${conversationId}?user_id=${userId}`;

    const chatBox = document.getElementById('chat-box');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const messageSellerButton = document.getElementById('message-seller-button');

    if (!chatBox || !messageInput || !sendButton || !messageSellerButton) {
        console.error("Required DOM elements are missing");
        return;
    }

    let ws;
    function initWebSocket() {
        if (!wsUrl) {
            console.error("WebSocket URL is undefined");
            return;
        }
        
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            console.log("WebSocket connected.");
        };

        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                appendMessage(data);
            } catch (error) {
                console.error("Error parsing incoming message:", error);
            }
        };

        ws.onclose = () => {
            console.error("WebSocket connection closed. Attempting to reconnect...");
            setTimeout(initWebSocket, 5000);
        };

        ws.onerror = (error) => {
            console.error("WebSocket error:", error);
        };
    }

    function appendMessage(data) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', data.sender_id == userId ? 'you' : 'them');
        messageElement.innerHTML = `
            <div class="sender">${data.sender_id == userId ? 'You' : otherUserName}</div>
            <div class="content">${data.message_body}</div>
        `;
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    fetch(`http://127.0.0.1:8000/conversations/${conversationId}/messages`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to load messages: ${response.status}`);
            }
            return response.json();
        })
        .then(messages => {
            messages.forEach(message => appendMessage(message));
        })
        .catch(error => {
            console.error("Failed to load messages:", error);
        });

    sendButton.addEventListener('click', () => {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert("WebSocket is not connected. Please try again.");
            return;
        }

        const messageBody = messageInput.value.trim();
        if (!messageBody) {
            alert("Message cannot be empty.");
            return;
        }

        const messageData = { sender_id: userId, message_body: messageBody };

        try {
            ws.send(JSON.stringify(messageData));
            messageInput.value = '';
        } catch (error) {
            console.error("Failed to send message:", error);
        }
    });

    initWebSocket();

    messageSellerButton.addEventListener("click", () => {
        const data = {
            participant_2: sellerId,
            item_id: itemId,
        };

        fetch('/start-conversation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                window.location.href = `/chat/${data.id}`;
            } else {
                console.error("Failed to find or create conversation.");
            }
        })
        .catch(error => console.error('Error:', error));
    });
});
</script>
{% endblock %}

